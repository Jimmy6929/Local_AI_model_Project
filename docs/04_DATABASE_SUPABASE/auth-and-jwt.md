---
tags:
  - database
cssclasses:
  - database-doc
---

# Auth and JWT

## Overview

Authentication via [[Supabase]] Auth, with JWT tokens for API authorization.

For UI implementation, see [[auth-ux]].
For security context, see [[threat-model]].

---

## Authentication Flow

### User Signup
1. User enters email + password in [[ui-pages-and-components|Web App]] — see [[auth-ux]]
2. Web App calls [[Supabase]] Auth signup endpoint
3. Supabase creates user in auth.users
4. Trigger creates [[schema|profile in public.profiles]]
5. User receives confirmation email (if enabled)
6. On confirmation, user can login

### User Login
1. User enters credentials — see [[auth-ux]]
2. Web App calls [[Supabase]] Auth login endpoint
3. Supabase validates credentials
4. Returns access_token (JWT) and refresh_token
5. Web App stores tokens securely — see [[secrets-management]]
6. Subsequent requests include JWT

### Session Refresh
1. Access token expires (default: 1 hour)
2. Web App uses refresh_token to get new access_token
3. [[Supabase]] validates refresh_token
4. Returns new access_token
5. Process repeats until refresh_token expires or revoked

---

## JWT Structure

### Payload (Claims)
| Claim | Description |
|-------|-------------|
| sub | User ID (UUID) |
| email | User email |
| role | authenticated |
| iat | Issued at timestamp |
| exp | Expiration timestamp |
| aud | Audience (authenticated) |

### Example Decoded JWT
```
{
  "sub": "a1b2c3d4-...",
  "email": "user@example.com",
  "role": "authenticated",
  "iat": 1700000000,
  "exp": 1700003600,
  "aud": "authenticated"
}
```

---

## JWT Validation in Gateway

See [[gateway-responsibilities]] for full context.

### Steps
1. Extract JWT from Authorization header: `Bearer <token>`
2. Verify signature using [[secrets-management|Supabase JWT secret]]
3. Check expiration (exp > current time)
4. Extract user_id from sub claim
5. Use user_id for [[schema|database queries]] and [[rls-policies|RLS]]

### Error Handling
| Scenario | Response |
|----------|----------|
| No token | 401 Unauthorized |
| Invalid signature | 401 Unauthorized |
| Expired token | 401 Unauthorized |
| Invalid format | 400 Bad Request |

---

## Token Storage in Web App

### Options

**httpOnly Cookie (Recommended)**
- Set by Supabase Auth
- Not accessible to JavaScript
- Automatic inclusion in requests
- CSRF protection needed

**Secure Storage (localStorage + safeguards)**
- Easy access for SPA
- Vulnerable to XSS
- Must sanitize all user input

### Recommendation
Use Supabase JS client which handles storage automatically. For custom handling, prefer httpOnly cookies.

---

## Profile Creation Trigger

When user signs up, automatically create profile:

### Trigger Logic
1. Listen to INSERT on auth.users
2. Create row in public.profiles with:
   - id = new user id
   - email = new user email
   - created_at = now()
3. Return

### Benefits
- Profile always exists for authenticated user
- No manual profile creation needed
- Enforces data consistency

---

## Service Role vs Anon Key

### Anonymous Key (Public)
- Included in client-side code
- Subject to RLS policies
- Safe to expose
- Used by Web App

### Service Role Key (Secret)
- Bypasses RLS
- Full database access
- NEVER expose to client
- Used only by Gateway backend

### Usage Matrix
| Operation | Which Key |
|-----------|-----------|
| User auth | anon key |
| User data access | anon key (RLS enforced) |
| Background jobs | service role |
| Admin operations | service role |
| Document processing | service role |

---

## Security Considerations

### JWT Secret
- Generated by Supabase, not user-created
- Must match between Auth server and Gateway
- Rotate if compromised

### Token Expiration
- Access token: 1 hour (configurable)
- Refresh token: 1 week (configurable)
- Shorter = more secure, less convenient

### Logout
- Clear tokens from client storage
- Optionally revoke refresh token on server
- Supabase provides signOut method

### Session Management
- Supabase tracks active sessions
- Can revoke sessions from dashboard
- Consider implementing session listing in app (future)

---

## Configuration in Gateway

### Required Environment Variables
| Variable | Description |
|----------|-------------|
| SUPABASE_URL | Base URL for Supabase project |
| SUPABASE_ANON_KEY | For client operations |
| SUPABASE_SERVICE_KEY | For privileged operations |
| SUPABASE_JWT_SECRET | For verifying JWTs locally |

### JWT Verification Library
- Use standard JWT library
- Algorithm: HS256
- Secret: SUPABASE_JWT_SECRET

---

## Checklist: Auth Setup

- [ ] Supabase Auth configured
- [ ] Email templates customized (optional)
- [ ] Profile creation trigger working
- [ ] JWT verification in Gateway working
- [ ] Tokens stored securely in Web App
- [ ] Token refresh flow tested
- [ ] Logout clears all tokens
- [ ] Service role key secured
- [ ] Error handling for auth failures

